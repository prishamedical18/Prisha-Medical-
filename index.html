<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisha Medical - Final Verified Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tab-content { display: none !important; }
        .tab-content.active { display: block !important; }
        #loginPage { position: fixed; inset: 0; z-index: 9999; display: flex; background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%); flex-direction: column; align-items: center; justify-content: start; padding: 1.5rem; color: white; overflow-y: auto; }
        #appInterface { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .custom-input { background: white !important; color: #111827 !important; border: 2px solid transparent; transition: all 0.3s ease; }
        .custom-input:focus { border-color: #fbbf24; outline: none; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .upload-card { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 2.5rem; }
    </style>
</head>
<body class="bg-gray-50 pb-32">

    <div id="loginPage">
        <div class="w-full max-w-md text-center mt-10 mb-6">
            <div class="w-20 h-20 bg-yellow-400 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-2xl rotate-3">
                <i class="fa-solid fa-hand-holding-medical text-4xl text-blue-900"></i>
            </div>
            <h1 class="text-4xl font-black italic uppercase tracking-tighter">PRISHA <span class="text-yellow-400">MEDICAL</span></h1>
            <p class="text-blue-100 text-[10px] font-bold uppercase mt-1 italic">Quality Healthcare At Home</p>
        </div>
        <div class="w-full max-w-md glass-panel p-8 rounded-[3rem] shadow-2xl">
            <div class="space-y-4">
                <input type="text" id="uName" placeholder="आपका पूरा नाम" class="w-full p-4 rounded-2xl custom-input font-bold">
                <input type="number" id="uPhone" placeholder="मोबाइल नंबर" class="w-full p-4 rounded-2xl custom-input font-bold">
                <input type="text" id="uVillage" placeholder="गांव / शहर का नाम" class="w-full p-4 rounded-2xl custom-input font-bold">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="uBlock" placeholder="ब्लॉक / तहसील" class="p-4 rounded-2xl custom-input font-bold text-sm">
                    <input type="number" id="uPin" placeholder="पिन कोड" class="p-4 rounded-2xl custom-input font-bold text-sm">
                </div>
                <button type="button" onclick="handlePrishaLogin()" class="w-full bg-yellow-400 text-blue-900 py-5 rounded-2xl font-black uppercase shadow-xl mt-4 active:scale-95 transition-all">START SHOPPING</button>
            </div>
        </div>
    </div>

    <div id="appInterface">
        <header class="bg-blue-600 p-5 sticky top-0 z-50 shadow-lg rounded-b-[2rem]">
            <div class="max-w-4xl mx-auto flex justify-between items-center text-white mb-4">
                <h1 class="text-xl font-black italic uppercase">PRISHA <span class="text-yellow-400">MEDICAL</span></h1>
                <div class="flex gap-3">
                    <button onclick="showTab('profile-tab', this)" class="bg-blue-500 p-2 rounded-full w-10 h-10 border border-blue-400"><i class="fa-solid fa-user"></i></button>
                    <button onclick="showTab('help-tab', this)" class="bg-blue-500 p-2 rounded-full w-10 h-10 border border-blue-400"><i class="fa-solid fa-circle-question"></i></button>
                </div>
            </div>
            <div class="max-w-4xl mx-auto flex gap-2">
                <input type="text" id="search" onkeyup="filterMeds()" placeholder="नाम या साल्ट से खोजें..." class="w-full p-4 rounded-2xl outline-none shadow-inner text-sm font-medium">
                <a href="tel:9229262539" class="bg-red-500 text-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg"><i class="fa-solid fa-heart-pulse text-2xl"></i></a>
            </div>
        </header>

        <main id="home-tab" class="tab-content active max-w-4xl mx-auto p-4">
            <div class="upload-card p-6 mb-8 shadow-2xl flex items-center justify-between text-white">
                <div class="z-10">
                    <h2 class="text-2xl font-black uppercase italic tracking-tighter leading-tight">Order via<br><span class="text-yellow-400">Prescription</span></h2>
                    <p class="text-[10px] font-bold opacity-90 mt-2 uppercase italic bg-blue-900/30 px-3 py-1 rounded-full inline-block">पर्चा अपलोड करें</p>
                </div>
                <label class="bg-white text-blue-900 w-16 h-16 rounded-2xl flex items-center justify-center cursor-pointer active:scale-90">
                    <i class="fa-solid fa-camera-retro text-3xl"></i>
                    <input type="file" id="prescInput" class="hidden" accept="image/*" onchange="uploadPrescription(this)">
                </label>
            </div>
            <div id="expertBar" class="flex gap-4 overflow-x-auto pb-6 no-scrollbar mb-4"></div>
            <h2 class="font-bold text-gray-800 mb-4 ml-2 italic underline uppercase text-sm">Medicines For You</h2>
            <div id="medGrid" class="grid grid-cols-2 gap-4"></div>
        </main>

        <main id="cart-tab" class="tab-content max-w-4xl mx-auto p-4">
            <h2 class="text-xl font-black mb-6 text-blue-800 italic uppercase underline text-center">Shopping Cart</h2>
            <div id="cartItemsList" class="space-y-4 mb-24"></div>
            <div id="cartFooter" class="fixed bottom-24 left-0 right-0 p-4 bg-white border-t hidden shadow-inner z-40">
                <div class="max-w-4xl mx-auto flex justify-between items-center">
                    <div><p class="text-[10px] font-bold text-gray-400 uppercase">Total Bill</p><p id="cartTotal" class="text-xl font-black text-blue-700 italic">₹0</p></div>
                    <button onclick="checkout()" class="bg-yellow-400 text-blue-900 px-8 py-3 rounded-2xl font-black uppercase shadow-lg">Place Order</button>
                </div>
            </div>
        </main>

        <main id="orders-tab" class="tab-content max-w-4xl mx-auto p-4">
            <h2 class="text-xl font-black mb-6 text-blue-800 italic uppercase underline text-center">Order History</h2>
            <div id="orderList" class="space-y-4"></div>
        </main>

        <main id="help-tab" class="tab-content max-w-4xl mx-auto p-4">
            <h2 class="text-xl font-black mb-6 text-blue-800 italic uppercase underline text-center">Support Center</h2>
            <div class="space-y-6">
                <a href="tel:8825301295" class="block bg-white rounded-[2.5rem] p-6 shadow-xl border-l-[10px] border-green-500">
                    <h3 class="font-black text-gray-800 uppercase">Order Queries</h3>
                    <p class="text-green-600 font-bold">CALL 8825301295</p>
                </a>
                <a href="tel:9229262539" class="block bg-white rounded-[2.5rem] p-6 shadow-xl border-l-[10px] border-blue-600">
                    <h3 class="font-black text-gray-800 uppercase">Technical Issues</h3>
                    <p class="text-blue-600 font-bold">CALL 9229262539</p>
                </a>
            </div>
        </main>

        <main id="profile-tab" class="tab-content max-w-4xl mx-auto p-4">
            <div class="bg-white rounded-[2.5rem] p-8 shadow-xl text-center border">
                <h3 id="profName" class="text-2xl font-black text-gray-800 uppercase italic">User</h3>
                <p id="profPhone" class="text-blue-600 font-bold mb-4">+91 0000000000</p>
                <div id="profAddr" class="text-left bg-gray-50 p-4 rounded-2xl mb-8 border font-bold text-gray-700 italic">Address</div>
                <button onclick="handleLogout()" class="w-full bg-red-500 text-white py-4 rounded-2xl font-black uppercase shadow-xl">LOGOUT</button>
            </div>
        </main>

        <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-4 shadow-2xl z-50 rounded-t-[2.5rem]">
            <button onclick="showTab('home-tab', this)" class="nav-btn active text-blue-600 flex flex-col items-center"><i class="fa-solid fa-house"></i></button>
            <button onclick="showTab('cart-tab', this)" class="nav-btn text-gray-400 flex flex-col items-center relative">
                <i class="fa-solid fa-cart-shopping"></i>
                <span id="cartBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
            </button>
            <button onclick="showTab('orders-tab', this)" class="nav-btn text-gray-400 flex flex-col items-center"><i class="fa-solid fa-truck-fast"></i></button>
        </nav>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAhd2hHsaqoIGm1GOen_sjld1TE6U_ZxPs",
            authDomain: "prisha-medical-18.firebaseapp.com",
            databaseURL: "https://prisha-medical-18-default-rtdb.firebaseio.com",
            projectId: "prisha-medical-18",
            storageBucket: "prisha-medical-18.firebasestorage.app",
            messagingSenderId: "631420249284",
            appId: "1:631420249284:web:80660211aa960f3cf5d591",
            measurementId: "G-JLCNJG3K18"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myCart = [];
        let allMeds = {};

        function handlePrishaLogin() {
            const n = document.getElementById('uName').value;
            const p = document.getElementById('uPhone').value;
            const v = document.getElementById('uVillage').value;
            const b = document.getElementById('uBlock').value;
            const pin = document.getElementById('uPin').value;
            if(!n || !p || !v || !b || !pin) { alert("Puri details bhariye!"); return; }
            
            const user = { 
                name: n, 
                phone: p, 
                address: `${v}, Block: ${b}, Pin: ${pin}`, // admin panel sync field
                fullAddress: `${v}, Block: ${b}, Pin: ${pin}`, 
                lastLogin: new Date().toLocaleString('en-IN')
            };

            // Database sync for Admin visibility
            db.ref('pUsers/' + p).set(user).then(() => {
                localStorage.setItem('prishaUser', JSON.stringify(user));
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appInterface').style.display = 'block';
                updateProfileUI(user);
                syncCloudStore();
                renderOrders();
            });
        }

        window.onload = function() {
            const user = JSON.parse(localStorage.getItem('prishaUser'));
            if(user) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appInterface').style.display = 'block';
                updateProfileUI(user);
                syncCloudStore();
                renderOrders();
                // Update login record in cloud
                db.ref('pUsers/' + user.phone).update({ lastLogin: new Date().toLocaleString('en-IN') });
            }
        };

        function updateProfileUI(u) {
            if(document.getElementById('profName')) document.getElementById('profName').innerText = u.name;
            if(document.getElementById('profPhone')) document.getElementById('profPhone').innerText = "+91 " + u.phone;
            if(document.getElementById('profAddr')) document.getElementById('profAddr').innerText = u.fullAddress;
        }

        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-blue-600', 'text-gray-400'));
            if(btn) btn.classList.replace('text-gray-400', 'text-blue-600');
            if(tabId === 'cart-tab') renderCart();
            if(tabId === 'orders-tab') renderOrders();
        }

        function uploadPrescription(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const user = JSON.parse(localStorage.getItem('prishaUser'));
                    db.ref('pOrders').push({
                        ...user,
                        item: "PRESCRIPTION (Parcha Uploaded)",
                        price: "Pending",
                        img: e.target.result,
                        status: 'Received',
                        time: new Date().toLocaleString('en-IN')
                    }).then(() => {
                        alert("Parcha bhej diya gaya!");
                        showTab('orders-tab', document.querySelectorAll('.nav-btn')[2]);
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function syncCloudStore() {
            // SYNC EXPERTS
            db.ref('pExperts').on('value', snap => {
                const exps = snap.val() || {};
                document.getElementById('expertBar').innerHTML = Object.keys(exps).map(k => `
                    <div class="min-w-[110px] bg-white p-3 rounded-[2.5rem] border text-center shadow-sm">
                        <a href="tel:${exps[k].phone}"><img src="${exps[k].img}" class="w-14 h-14 rounded-full mx-auto object-cover border-2 border-blue-500 mb-1"></a>
                        <h4 class="font-black text-[9px] uppercase italic leading-none">${exps[k].name}</h4>
                    </div>`).join('');
            });
            // SYNC MEDICINES
            db.ref('pMeds').on('value', snap => {
                allMeds = snap.val() || {};
                renderMedicineGrid(allMeds);
            });
        }

        function renderMedicineGrid(meds) {
            document.getElementById('medGrid').innerHTML = Object.keys(meds).map(k => {
                const m = meds[k];
                return `<div class="bg-white p-4 rounded-[2.5rem] border flex flex-col justify-between shadow-sm">
                    <img src="${m.img}" class="h-28 w-full object-contain mb-2 rounded-xl">
                    <h3 class="font-black text-[11px] uppercase h-8 overflow-hidden italic leading-tight text-gray-800">${m.name}</h3>
                    <p class="text-[10px] font-black text-blue-700 mt-1">₹${m.price}</p>
                    <button onclick="addToCart('${m.name}', ${m.price}, '${m.img}')" class="w-full bg-blue-600 text-white py-2 rounded-full text-[9px] font-black uppercase mt-2 shadow-md active:scale-95">Add</button>
                </div>`;
            }).join('');
        }

        function renderOrders() {
            const user = JSON.parse(localStorage.getItem('prishaUser'));
            if(!user) return;
            db.ref('pOrders').on('value', snap => {
                const data = snap.val() || {};
                const list = Object.keys(data).map(k => ({...data[k], key: k}))
                             .filter(o => o.phone === user.phone).reverse();
                
                document.getElementById('orderList').innerHTML = list.map(o => {
                    const canCancel = (o.status === 'Received' || o.status === 'Accepted');
                    return `<div class="bg-white p-5 rounded-[2rem] border-l-8 ${o.status==='Cancelled'?'border-red-400':'border-blue-600'} shadow-sm mb-3">
                        <div class="flex items-start gap-3">
                            <img src="${o.img}" class="w-14 h-14 object-contain rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-black text-xs uppercase italic">${o.item}</h4>
                                <p class="text-[10px] text-gray-500">${o.time}</p>
                                <p class="font-bold text-blue-600 text-sm mt-1">Status: ${o.status}</p>
                            </div>
                            ${canCancel ? `<button onclick="cancelMyOrder('${o.key}')" class="text-red-500 text-[10px] font-black underline">CANCEL</button>` : ''}
                        </div>
                    </div>`;
                }).join('') || '<p class="text-center py-10 text-gray-400 font-bold italic">No Orders Found</p>';
            });
        }

        function cancelMyOrder(key) {
            if(confirm("Order cancel karein?")) {
                db.ref('pOrders/' + key).update({ status: 'Cancelled' });
            }
        }

        function addToCart(name, price, img) {
            const index = myCart.findIndex(i => i.name === name);
            if(index > -1) { myCart[index].qty++; } 
            else { myCart.push({name, price, img, qty: 1}); }
            updateCartBadge();
            alert("Added to cart!");
        }

        function updateCartBadge() {
            const b = document.getElementById('cartBadge');
            if(b) {
                b.innerText = myCart.length;
                b.classList.toggle('hidden', myCart.length === 0);
            }
        }

        function renderCart() {
            const list = document.getElementById('cartItemsList');
            const footer = document.getElementById('cartFooter');
            if (myCart.length === 0) {
                list.innerHTML = `<p class="text-center py-20 text-gray-400 font-bold italic">Cart Khali Hai!</p>`;
                footer.classList.add('hidden');
                return;
            }
            footer.classList.remove('hidden');
            let total = 0;
            list.innerHTML = myCart.map((item, index) => {
                total += (item.price * item.qty);
                return `<div class="bg-white p-4 rounded-[2rem] border flex items-center gap-4 shadow-sm">
                    <img src="${item.img}" class="w-14 h-14 object-contain">
                    <div class="flex-1"><h4 class="font-black text-xs uppercase italic">${item.name}</h4><p class="text-blue-600 font-bold">₹${item.price} x ${item.qty}</p></div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeQty(${index}, -1)" class="w-8 h-8 bg-gray-100 rounded-full font-black text-xs">-</button>
                        <span class="font-black text-xs">${item.qty}</span>
                        <button onclick="changeQty(${index}, 1)" class="w-8 h-8 bg-blue-100 text-blue-700 rounded-full font-black text-xs">+</button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('cartTotal').innerText = "₹" + total;
        }

        function changeQty(index, val) {
            myCart[index].qty += val;
            if(myCart[index].qty <= 0) myCart.splice(index, 1);
            updateCartBadge();
            renderCart();
        }

        function checkout() {
            const user = JSON.parse(localStorage.getItem('prishaUser'));
            const time = new Date().toLocaleString('en-IN');
            myCart.forEach(item => {
                db.ref('pOrders').push({...user, item: `${item.name} (Qty: ${item.qty})`, price: item.price * item.qty, img: item.img, status: 'Received', time: time});
            });
            myCart = []; updateCartBadge(); alert("Order Placed!"); 
            showTab('orders-tab', document.querySelectorAll('.nav-btn')[2]);
        }

        function filterMeds() {
            const q = document.getElementById('search').value.toLowerCase();
            const filtered = {};
            Object.keys(allMeds).forEach(k => {
                if(allMeds[k].name.toLowerCase().includes(q)) filtered[k] = allMeds[k];
            });
            renderMedicineGrid(filtered);
        }

        function handleLogout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
