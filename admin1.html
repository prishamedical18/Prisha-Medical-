<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRISHA ADMIN - MASTER PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        body { background: #f1f5f9; font-family: sans-serif; }
        .tab-content { display: none !important; }
        .tab-content.active { display: block !important; }
        .nav-active { background: #2874f0 !important; color: white !important; box-shadow: 0 4px 12px rgba(40,116,240,0.4); }
        .status-Received { background: #f1f3f6; color: #717478; }
        .status-Accepted { background: #fff9e6; color: #9a7300; }
        .status-Shipped { background: #e7f3ff; color: #0071dc; }
        .status-Delivered { background: #e6f7ef; color: #008c48; }
        .status-Rejected { background: #fee2e2; color: #dc2626; }
        .status-Completed { background: #008c48 !important; color: white !important; font-weight: bold; }
        #adminMainPanel { display: none; }
        #securityOverlay { display: flex; }
        
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                display: block !important; 
                background: white;
            }
        }
    </style>
</head>
<body class="pb-24">

    <div id="securityOverlay" class="fixed inset-0 bg-[#2874f0] z-[1000] flex flex-col items-center justify-center p-6 text-white">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-sm text-center text-gray-800">
            <h1 class="text-2xl font-black text-[#2874f0] mb-2 uppercase italic tracking-tighter">PRISHA <span class="text-yellow-500">ADMIN</span></h1>
            <p class="text-[10px] font-bold text-gray-400 mb-6 uppercase tracking-widest border-b pb-2">Master Security Layer</p>
            <input type="password" id="adminPassInput" placeholder="Master Password" class="w-full px-4 py-4 rounded-2xl bg-gray-100 mb-4 text-center font-bold outline-none border-2 focus:border-[#2874f0]">
            <button type="button" onclick="checkAdminAccess()" class="w-full bg-[#2874f0] text-white py-4 rounded-2xl font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Unlock System</button>
        </div>
    </div>

    <div id="adminMainPanel">
        <header class="bg-[#2874f0] text-white p-4 sticky top-0 z-50 shadow-xl">
            <div class="max-w-6xl mx-auto flex flex-col items-center gap-4">
                <div class="flex justify-between items-center w-full">
                    <h1 class="text-2xl font-black italic uppercase">PRISHA <span class="text-yellow-400">ADMIN</span></h1>
                    <button onclick="adminLogout()" class="bg-red-500 px-3 py-1 rounded-lg text-[8px] font-black uppercase shadow-lg italic">Logout</button>
                </div>
                <div class="flex gap-2 overflow-x-auto w-full no-scrollbar justify-center">
                    <button onclick="openTab('sec-orders', this)" class="tab-btn nav-active px-5 py-2 rounded-xl text-[10px] font-bold uppercase">Orders</button>
                    <button onclick="openTab('sec-catalogue', this)" class="tab-btn bg-white/10 px-5 py-2 rounded-xl text-[10px] font-bold uppercase">Catalogue</button>
                    <button onclick="openTab('sec-experts', this)" class="tab-btn bg-white/10 px-5 py-2 rounded-xl text-[10px] font-bold uppercase">Experts</button>
                    <button onclick="openTab('sec-add', this)" id="addTabBtn" class="tab-btn bg-white/10 px-5 py-2 rounded-xl text-[10px] font-bold uppercase">+ Add Medicine</button>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto p-4 mt-2">
            <div id="sec-orders" class="tab-content active">
                <div class="bg-white rounded-3xl p-5 border-t-4 border-red-500 shadow-sm">
                    <h2 class="font-bold text-gray-700 mb-6 text-xs uppercase italic"><i class="fa-solid fa-truck-fast"></i> Order Processing</h2>
                    <div id="orderList" class="space-y-4"></div>
                </div>
            </div>

            <div id="sec-catalogue" class="tab-content">
                <div class="bg-white rounded-3xl p-4 border-t-4 border-orange-500">
                    <input type="text" id="medSearch" oninput="renderCatalogue()" placeholder="Search medicine by name..." class="p-3 border rounded-xl text-[10px] w-full mb-4 bg-gray-50 outline-none focus:border-orange-500">
                    <table class="w-full text-left text-[10px]">
                        <thead>
                            <tr class="text-gray-400 uppercase text-[8px] border-b">
                                <th class="p-3">Img</th>
                                <th class="p-3">Medicine Info</th>
                                <th class="p-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="catalogueBody" class="divide-y"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-experts" class="tab-content">
                <div id="expFormCard" class="bg-white rounded-3xl p-6 shadow-sm border-t-4 border-green-500 mb-8">
                    <h2 id="expFormTitle" class="font-bold text-gray-700 mb-4 text-xs uppercase italic text-center">Add/Edit Expert</h2>
                    <input type="hidden" id="editExpId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="drN" placeholder="Full Name" class="p-3 border rounded-xl text-sm bg-gray-50">
                        <select id="drRole" class="p-3 border rounded-xl text-sm bg-gray-50 font-bold"><option value="PHARMACIST">PHARMACIST</option><option value="DOCTOR">DOCTOR</option><option value="SUPPORTIVE STAFF">SUPPORTIVE STAFF</option></select>
                        <input type="text" id="drDeg" placeholder="Degree" class="p-3 border rounded-xl text-sm bg-gray-50">
                        <input type="text" id="drCol" placeholder="College" class="p-3 border rounded-xl text-sm bg-gray-50">
                        <input type="number" id="drExp" placeholder="Experience" class="p-3 border rounded-xl text-sm bg-gray-50">
                        <input type="number" id="drPhone" placeholder="Phone" class="p-3 border rounded-xl text-sm bg-gray-50">
                        <input type="file" id="drF" class="text-[10px] p-2 bg-white">
                    </div>
                    <button onclick="saveExpertData()" class="w-full bg-green-600 text-white py-4 mt-4 rounded-2xl font-bold uppercase shadow-lg">Save Expert</button>
                </div>
                <div id="expertGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <div id="sec-add" class="tab-content">
                <div class="bg-white rounded-[2.5rem] shadow-2xl p-8 max-w-lg mx-auto border-t-8 border-blue-600">
                    <h2 id="medFormTitle" class="text-xl font-black text-blue-700 mb-8 text-center uppercase italic">Medicine Cloud Setup</h2>
                    <div class="space-y-5">
                        <input type="hidden" id="editMedId">
                        <input type="text" id="mN" placeholder="Brand Name" class="w-full p-4 border-2 rounded-2xl text-sm bg-gray-50">
                        <input type="text" id="mB" placeholder="Company Name" class="w-full p-4 border-2 rounded-2xl text-sm bg-yellow-50 font-bold">
                        <input type="text" id="mS" placeholder="Salt Composition" class="w-full p-4 border-2 rounded-2xl text-sm bg-blue-50">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="mM" placeholder="MRP" class="p-4 border-2 rounded-2xl">
                            <input type="number" id="mP" placeholder="Selling Price" class="p-4 border-2 rounded-2xl bg-green-50">
                        </div>
                        <input type="file" id="mF" class="text-xs">
                        <button id="medSubmitBtn" onclick="saveMedicineData()" class="w-full bg-[#fb641b] text-white py-5 rounded-2xl font-black uppercase text-sm">Submit to Cloud</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="printArea" class="hidden"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAhd2hHsaqoIGm1GOen_sjld1TE6U_ZxPs",
            authDomain: "prisha-medical-18.firebaseapp.com",
            projectId: "prisha-medical-18",
            storageBucket: "prisha-medical-18.firebasestorage.app",
            messagingSenderId: "631420249284",
            appId: "1:631420249284:web:80660211aa960f3cf5d591",
            databaseURL: "https://prisha-medical-18-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const MASTER_PASS = "Prisha@2025";

        function checkAdminAccess() {
            const pass = document.getElementById('adminPassInput').value;
            if(pass === MASTER_PASS) {
                document.getElementById('securityOverlay').style.display = 'none';
                document.getElementById('adminMainPanel').style.display = 'block';
                sessionStorage.setItem('prishaAuth', 'true');
                startCloudSync();
            } else { alert("Incorrect Password!"); }
        }

        window.onload = function() {
            if(sessionStorage.getItem('prishaAuth') === 'true') {
                document.getElementById('securityOverlay').style.display = 'none';
                document.getElementById('adminMainPanel').style.display = 'block';
                startCloudSync();
            }
        };

        function adminLogout() { sessionStorage.removeItem('prishaAuth'); location.reload(); }

        function startCloudSync() {
            // Address fetch karne ke liye pUsers par bhi nazar rakhenge
            db.ref('pUsers').on('value', uSnap => {
                window.allUsers = uSnap.val() || {};
                db.ref('pOrders').on('value', snap => renderOrders(snap.val()));
            });
            db.ref('pMeds').on('value', snap => { window.currentMeds = snap.val(); renderCatalogue(); });
            db.ref('pExperts').on('value', snap => renderExperts(snap.val()));
        }

        function renderOrders(orders) {
            const list = document.getElementById('orderList');
            if(!orders) { list.innerHTML = "<p class='text-center py-10 font-bold text-gray-400 uppercase tracking-widest'>No active orders</p>"; return; }
            
            const grouped = {};
            Object.keys(orders).forEach(id => {
                const o = orders[id]; const key = o.time + "_" + (o.phone || 'no_phone');
                if(!grouped[key]) grouped[key] = { ...o, ids: [id], items: [o.item] };
                else { grouped[key].items.push(o.item); grouped[key].ids.push(id); }
            });

            list.innerHTML = Object.values(grouped).reverse().map(group => {
                const allItems = group.items.join(" + ");
                const idsJson = JSON.stringify(group.ids);
                
                // Profile (pUsers) se address aur name uthana
                const userProfile = window.allUsers ? window.allUsers[group.phone] : null;
                const address = userProfile?.address || group.address || "Address Not Found";
                const customer = userProfile?.name || group.customer || group.name || "Unknown Customer";

                let pImage = group.img ? `<div class="mt-2"><p class="text-[9px] font-bold text-red-500 italic uppercase">Parcha:</p><a href="${group.img}" target="_blank"><img src="${group.img}" class="w-full max-h-40 object-contain rounded-xl border border-blue-200 shadow-sm bg-white"></a></div>` : "";

                let btns = `<button onclick='printBill(${JSON.stringify(group)})' class="bg-gray-800 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase mr-auto"><i class="fa-solid fa-print"></i> Bill</button>`;
                
                if(group.status === 'Received') {
                    btns += `<button onclick='updateStatus(${idsJson}, "Accepted")' class="bg-yellow-500 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase mr-1">Accept</button>`;
                    btns += `<button onclick='updateStatus(${idsJson}, "Rejected")' class="bg-red-600 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase">Reject</button>`;
                }
                else if(group.status === 'Accepted') btns += `<button onclick='updateStatus(${idsJson}, "Shipped")' class="bg-blue-600 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase">Ship</button>`;
                else if(group.status === 'Shipped') btns += `<button onclick='updateStatus(${idsJson}, "Delivered")' class="bg-orange-500 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase">Deliver</button>`;
                else if(group.status === 'Delivered') btns += `<button onclick='updateStatus(${idsJson}, "Completed")' class="bg-green-700 text-white px-3 py-2 rounded-xl text-[10px] font-bold uppercase">Finish</button>`;
                else if(group.status === 'Completed') btns += `<span class="text-green-600 font-black text-[10px] italic">✔ COMPLETED</span>`;
                else if(group.status === 'Rejected') btns += `<span class="text-red-600 font-black text-[10px] italic">✖ REJECTED</span>`;
                
                return `<div class="bg-slate-50 p-5 rounded-[2rem] border shadow-sm flex flex-col gap-3">
                    <div class="flex justify-between items-start"><div class="flex-1"><b class="text-blue-800 text-sm uppercase">${allItems}</b><br><span class="text-[10px] font-bold text-gray-400 uppercase">Customer: ${customer}</span></div><span class="px-3 py-1 rounded-full text-[8px] font-black uppercase status-${group.status}">${group.status}</span></div>
                    ${pImage}
                    <p class="text-[10px] text-gray-500 italic bg-white p-3 rounded-2xl border-l-4 border-blue-500">Address: ${address} | Ph: <b>${group.phone || 'N/A'}</b></p>
                    <div class="flex justify-end gap-2 border-t pt-3 mt-1">${btns}</div>
                </div>`;
            }).join('');
        }

        function printBill(data) {
            const printArea = document.getElementById('printArea');
            const itemsHtml = data.items.map(it => `<tr><td style="padding:10px; border-bottom:1px solid #ddd; font-size:14px;">${it}</td><td style="padding:10px; border-bottom:1px solid #ddd; text-align:right; font-size:14px;">1 Unit</td></tr>`).join('');
            const userProfile = window.allUsers ? window.allUsers[data.phone] : null;
            const addr = userProfile?.address || data.address || "Address Not Found";
            const cust = userProfile?.name || data.customer || "Unknown Customer";

            printArea.innerHTML = `<div style="padding:30px; background:white; color:black; font-family: sans-serif;"><div style="text-align:center; border-bottom:2px solid #2874f0; padding-bottom:10px;"><h1 style="margin:0; color:#2874f0; font-size:28px;">PRISHA MEDICAL</h1><p style="margin:5px 0; font-size:12px; font-weight:bold;">QUALITY MEDICINES AT BEST PRICE</p></div><div style="margin:20px 0; display:flex; justify-content:space-between;"><div style="font-size:14px;"><p><b>TO:</b> ${cust}</p><p><b>PHONE:</b> ${data.phone || 'N/A'}</p><p style="max-width:250px;"><b>ADDR:</b> ${addr}</p></div><div style="text-align:right; font-size:14px;"><p><b>DATE:</b> ${new Date().toLocaleDateString('en-IN')}</p></div></div><table style="width:100%; border-collapse:collapse; margin-top:20px;"><thead><tr style="background:#2874f0; color:white;"><th style="padding:10px; text-align:left;">Item Description</th><th style="padding:10px; text-align:right;">Qty</th></tr></thead><tbody>${itemsHtml}</tbody></table><div style="margin-top:50px; text-align:center; border-top:1px dashed #ccc; padding-top:20px;"><p style="font-size:12px;">Thank you for ordering with Prisha Medical!</p></div></div>`;
            setTimeout(() => { window.print(); }, 500);
        }

        function updateStatus(ids, s) { const up = {}; ids.forEach(id => { up[`pOrders/${id}/status`] = s; }); db.ref().update(up); }
        
        function openTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById(id).classList.add('active');
            if(btn) btn.classList.add('nav-active');
        }

        function saveMedicineData() {
            const n = document.getElementById('mN').value;
            const b = document.getElementById('mB').value;
            const p = document.getElementById('mP').value;
            const editId = document.getElementById('editMedId').value;
            if(!n || !b || !p) return alert("Required fields missing!");
            const data = { name:n, brand:b, salt:document.getElementById('mS').value, mrp:document.getElementById('mM').value, price:p };
            const f = document.getElementById('mF').files[0];
            const handleSave = (finalData) => {
                const ref = editId ? db.ref('pMeds/' + editId) : db.ref('pMeds').push();
                ref.set(finalData).then(() => { alert("Done!"); location.reload(); });
            };
            if(f) {
                const r = new FileReader();
                r.onload = (e) => { data.img = e.target.result; handleSave(data); };
                r.readAsDataURL(f);
            } else {
                if(editId) data.img = window.currentMeds[editId].img;
                handleSave(data);
            }
        }

        function renderCatalogue() {
            const meds = window.currentMeds || {};
            const searchTerm = document.getElementById('medSearch').value.toLowerCase();
            const sorted = Object.keys(meds)
                .filter(id => meds[id].name.toLowerCase().includes(searchTerm))
                .sort((a,b) => meds[a].name.localeCompare(meds[b].name));
            document.getElementById('catalogueBody').innerHTML = sorted.map(id => `<tr class="border-b"><td class="p-3"><img src="${meds[id].img || ''}" class="w-10 h-10 rounded object-cover"></td><td class="p-3"><b class="text-blue-700">${meds[id].name}</b><br><span class="text-[8px] font-bold uppercase bg-yellow-100">${meds[id].brand || 'No Brand'}</span><br><span class="text-[8px] text-gray-500 italic">MRP: ₹${meds[id].mrp || '0'}</span></td><td class="text-right p-3"><button onclick="editMedicine('${id}')" class="text-blue-600 font-bold mr-2">EDIT</button><button onclick="if(confirm('Delete this?')) db.ref('pMeds/${id}').remove()" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('');
        }

        function editMedicine(id) {
            const m = window.currentMeds[id];
            document.getElementById('editMedId').value = id;
            document.getElementById('mN').value = m.name;
            document.getElementById('mB').value = m.brand || "";
            document.getElementById('mS').value = m.salt || "";
            document.getElementById('mM').value = m.mrp || "";
            document.getElementById('mP').value = m.price || "";
            openTab('sec-add', document.getElementById('addTabBtn'));
        }

        function renderExperts(experts) {
            const grid = document.getElementById('expertGrid');
            if(!experts) { grid.innerHTML = ""; return; }
            grid.innerHTML = Object.keys(experts).map(id => {
                const ex = experts[id];
                return `<div class="bg-white p-4 rounded-3xl border shadow-sm text-center"><img src="${ex.img || ''}" class="w-20 h-20 rounded-full mx-auto object-cover border-4 border-blue-100 mb-2"><h3 class="font-bold text-blue-800 text-sm">${ex.name}</h3><p class="text-[10px] font-bold text-gray-400">${ex.role}</p><div class="flex justify-center gap-2 mt-3"><button onclick="editExpert('${id}')" class="text-blue-500 text-xs font-bold uppercase">Edit</button><button onclick="if(confirm('Delete?')) db.ref('pExperts/${id}').remove()" class="text-red-500 text-xs font-bold uppercase">Delete</button></div></div>`;
            }).join('');
        }

        function editExpert(id) {
            db.ref('pExperts/' + id).once('value', snap => {
                const ex = snap.val();
                document.getElementById('editExpId').value = id;
                document.getElementById('drN').value = ex.name;
                document.getElementById('drRole').value = ex.role;
                document.getElementById('drDeg').value = ex.degree;
                document.getElementById('drCol').value = ex.college;
                document.getElementById('drExp').value = ex.exp;
                document.getElementById('drPhone').value = ex.phone;
                document.getElementById('expFormTitle').innerText = "Update Expert Details";
                window.scrollTo(0,0);
            });
        }

        function saveExpertData() {
            const data = {
                name: document.getElementById('drN').value,
                role: document.getElementById('drRole').value,
                degree: document.getElementById('drDeg').value,
                college: document.getElementById('drCol').value,
                exp: document.getElementById('drExp').value,
                phone: document.getElementById('drPhone').value
            };
            const editId = document.getElementById('editExpId').value;
            const f = document.getElementById('drF').files[0];
            const handleSave = (finalData) => {
                const ref = editId ? db.ref('pExperts/' + editId) : db.ref('pExperts').push();
                ref.set(finalData).then(() => { alert("Expert Saved!"); location.reload(); });
            };
            if(f) {
                const r = new FileReader();
                r.onload = (e) => { data.img = e.target.result; handleSave(data); };
                r.readAsDataURL(f);
            } else { handleSave(data); }
        }
    </script>
</body>
</html>

